---
layout: post
title: 萌萌哒 JS
data: 2017-08-17
tags: js
desc: 另类 JS 代码
---

## 抓到一群萌萌哒颜表情

在知乎上刷到一个题目《如何有逼格地输出“Hello, World!”？》，里面有个颜表情版 JS 答案 :upside_down_face:：

```javascript
ﾟωﾟﾉ= /｀ｍ´）ﾉ ~┻━┻   //*´∇｀*/ ['_']; o=(ﾟｰﾟ)  =_=3; c=(ﾟΘﾟ) =(ﾟｰﾟ)-(ﾟｰﾟ); (ﾟДﾟ) =(ﾟΘﾟ)= (o^_^o)/ (o^_^o);(ﾟДﾟ)={ﾟΘﾟ: '_' ,ﾟωﾟﾉ : ((ﾟωﾟﾉ==3) +'_') [ﾟΘﾟ] ,ﾟｰﾟﾉ :(ﾟωﾟﾉ+ '_')[o^_^o -(ﾟΘﾟ)] ,ﾟДﾟﾉ:((ﾟｰﾟ==3) +'_')[ﾟｰﾟ] }; (ﾟДﾟ) [ﾟΘﾟ] =((ﾟωﾟﾉ==3) +'_') [c^_^o];(ﾟДﾟ) ['c'] = ((ﾟДﾟ)+'_') [ (ﾟｰﾟ)+(ﾟｰﾟ)-(ﾟΘﾟ) ];(ﾟДﾟ) ['o'] = ((ﾟДﾟ)+'_') [ﾟΘﾟ];(ﾟoﾟ)=(ﾟДﾟ) ['c']+(ﾟДﾟ) ['o']+(ﾟωﾟﾉ +'_')[ﾟΘﾟ]+ ((ﾟωﾟﾉ==3) +'_') [ﾟｰﾟ] + ((ﾟДﾟ) +'_') [(ﾟｰﾟ)+(ﾟｰﾟ)]+ ((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+((ﾟｰﾟ==3) +'_') [(ﾟｰﾟ) - (ﾟΘﾟ)]+(ﾟДﾟ) ['c']+((ﾟДﾟ)+'_') [(ﾟｰﾟ)+(ﾟｰﾟ)]+ (ﾟДﾟ) ['o']+((ﾟｰﾟ==3) +'_') [ﾟΘﾟ];(ﾟДﾟ) ['_'] =(o^_^o) [ﾟoﾟ] [ﾟoﾟ];(ﾟεﾟ)=((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+ (ﾟДﾟ) .ﾟДﾟﾉ+((ﾟДﾟ)+'_') [(ﾟｰﾟ) + (ﾟｰﾟ)]+((ﾟｰﾟ==3) +'_') [o^_^o -ﾟΘﾟ]+((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+ (ﾟωﾟﾉ +'_') [ﾟΘﾟ]; (ﾟｰﾟ)+=(ﾟΘﾟ); (ﾟДﾟ)[ﾟεﾟ]='\\'; (ﾟДﾟ).ﾟΘﾟﾉ=(ﾟДﾟ+ ﾟｰﾟ)[o^_^o -(ﾟΘﾟ)];(oﾟｰﾟo)=(ﾟωﾟﾉ +'_')[c^_^o];(ﾟДﾟ) [ﾟoﾟ]='\"';(ﾟДﾟ) ['_'] ( (ﾟДﾟ) ['_'] (ﾟεﾟ+(ﾟДﾟ)[ﾟoﾟ]+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟΘﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟoﾟ]) (ﾟΘﾟ)) ('_');
```

上面萌萌哒的代码等效于 `alert("Hello,World")`，代码转换器是 [aaencode](http://utf-8.jp/public/aaencode.html)。

与此类似，还有个 [JSFuck](http://www.jsfuck.com/)，它只使用 `[`、`]`、`(`、`)`、`!`和`+`六个字符来编码。如`alert(1)` 等效于:

```javascript
(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+(!![]+[])[+[]]+(![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[!+[]+!+[]+[+[]]]+[+!+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[!+[]+!+[]+[+[]]]
```

因崔斯挺！

## 为什么可以这么萌

JS 代码归根结底其实是字符串，所以无论是 aaencode 还是 JSFuck ，它们只是用**特定的字符集**拼接成等效的 JS 字符串。只不过 JS 代码使用的字符集是 **Unicode**，而 JSFuck 使用的是 `[]()!+`，aaencode 用的是多种颜表情。

因此，如果我们能用**特定的字符集**表示成 `[A-Za-z0-9]`，那么就能拼凑出基本的 JS 程序。下面以 JSFuck 为例，进行分析，如果理解了 JSFuck 的原理，那么 aaencode 也就迎刃而解了。

## 从数字开始

从简单的数字开始，如 0 和 1 。对于 0 和 1 ，通常会对应到 `false` 和 `true`。如果使用一元加法运算符 `+`，它可以把其他类型转为数字，那么就有：

```javascript
+[] === 0;
![] === false;
// leads to
!![] === true;
+!![] === 1;
```

有了 0 和 1 ，自然其他的数字就好办了，利用二元加法运算符：

```javascript
0 === +[];
1 === +!![];
2 === !![] + !![]; // true + true => 1 + 1
3 === !![] + !![] + !![]; // true + true + true => 1 + 1 + 1
...
```

0 - 9 的数字都可以按照以上规则得到。但是，对于更大的数字比如 100 ，难道也得拼接 100 个么？还有，小数怎么办？先别着急，我们先来看看如何凑出英文字符。

## 集齐英文字符

我们知道，二元加法运算中，如果两个操作数不都是数字的话，需要进行一些必要的类型转换。这个类型转换规则优先考虑字符串拼接，大多数情况下是使用 `toString()` 转换。

基于以上规则，由于从 `[]()+!` 中能拼凑出的对象仅有 `[]` ，刚好 `[]` 的 `toString()` 方法返回空字符串，所以有：

```javascript
"" === [] + []; 
```

这样我们就可以轻松地实现：数字 => 字符串。例如：

```javascript
"false" === [] + [] + ![]; // "" + false
"true" === [] + [] + !![]; // "" + true
```

结合一元加法运算，就可以实现：字符串 => 数字。所以要实现上面提到的大数字的拼接可以使用以下方法：

```javascript
100 === +([] + [] + +!![] + +![] + ![]); // +("" + 1 + 0 + 0)
```

所以对于英文字母，如果想得到字符 `a` 的话，就很简单了：

```javascript
"a" === ([] + [] + ![])[+!![]]; // ("false")[1]
```

使用这样的方法，我们就能从 `false` 和 `true` 里得到 8 个字符。像这样的，其实还有 `undefined`、`NaN`、`Infinity`等，但是这样并不能凑齐所有英文字母，也不能凑出类似`|`、`*`、`\`等字符。

其实，除了 `+`能实现数字 => 字符的转换以外，还有个 `String.fromCharCode()` 方法也能做到。根据上面的分析，目前为止我们已经可以凑出任何整形数值。所以，只要能凑齐 `String.fromCharCode()` 中的所有字符，就可以用该方法得到任意一个 Unicode 字符。

但是，`String.fromCharCode()` 中的 "." 要从何获取？"." 在 JS 中用在两个地方：

1. 获取对象的属性或方法
2. 小数点

很明显，1 就是我们想要获取的，这个是鸡生蛋、蛋生鸡循环，无解。所以我们只能从小数点上入手。对于小数点，首先要知道的是，如果一个数字中出现小数点并不意味着这个数字就是浮点数，因为科学计数法中也可能出现，如 `5.20e10` 。

既然科学计数法中会出现 "." ，那么把科学计数法表述的数字变成字符串不就可以得到 "." 了？

在 JS 中，以下两种情况下数值会自动转化为科学计数法表示：

* 小数点前的数字多于 21 位
* 小数点后的 0 多于 5 位

```javascript
1234567890123456789012
// 1.2345678901234568e+21
0.0000008
// 8e-7
```

所以，构建一个大于 21 位的整数就可以得到一个科学计数法表示数：

```javascript
11e20
// 1.1e+21
"." === ("" + 11e20)[1];
```

既然 "." 已经有了，那么前面提到的浮点数表示的问题也就解决了。

至此，已经有办法凑齐整个 Unicode 字符集。

## 让字符串运行起来

目前为止，使用上面分析的方法可以获取到完整的 Unicode 字符集，也就能够拼凑出任何的 JS **代码字符串**。注意，它仅仅是字符串，并不能自动运行。要让字符串作为代码运行起来，有两种办法：

1. `eval()`
2. `new Function()`

`eval()` 在这里并不能用，因为我们获取不到对它的引用。幸运的是，可以得到构造函数 `Function` 的引用。而且，`Function` 构造函数可以不使用 `new` 命令，其作用是一样的：

```javascript
new Function('alert("Hello,world!")')();
// 等效于
Function('alert("Hello,world!")')();
```

为了获取对 `Function` 构造函数的引用，首先需要获取一个函数，如 `[].pop`，那么 `[].pop.constructor` 就是 `Function` 构造函数。

所以：

```javascript
[]["pop"]["constructor"]('alert("Hello,world!")')();
// 等效于
Function('alert("Hello,world!")')();
```

最后再用字符串拼接方法拼凑出 `pop` 和 `constructor` 就可大功告成！

## 再看看颜表情版

颜表情版的原理是一致的，差别就在于它们选取的基本字符表示不一样。颜表情版利用 JS 默认支持 Unicode 的特性，使用颜表情来作为变量或者函数名。

以前三行代码为例：

```javascript
ﾟωﾟﾉ= /｀ｍ´）ﾉ ~┻━┻   //*´∇｀*/ ['_']; o=(ﾟｰﾟ)  =_=3; c=(ﾟΘﾟ) =(ﾟｰﾟ)-(ﾟｰﾟ); 
```

去掉注释并美化下，即：

```javascript
ﾟωﾟﾉ = /｀ｍ´）ﾉ ~┻━┻   /['_'];
o = (ﾟｰﾟ) = _ = 3;
c = (ﾟΘﾟ) = (ﾟｰﾟ) - (ﾟｰﾟ); 
```

可以看出，这里定义了好几个变量，有些变量名称是萌萌哒颜表情，如 `ﾟωﾟﾉ`、`ﾟｰﾟ`、`ﾟΘﾟ`。计算出这些变量的值，得到如下结果：

```javascript
ﾟωﾟﾉ = undefined;
_ = 3;
ﾟｰﾟ = 3;
o = 3;
ﾟΘﾟ = 0;
c = 0;
```

这样就获得了 `0`、`3`、`undefined`，再应用前面我们分析的方法，同样可以获得这个 Unicode 字符集。

## 参考文章

* [讓 JavaSript 難以閱讀：jsfuck 與 aaencode](http://blog.techbridge.cc/2016/07/16/javascript-jsfuck-and-aaencode/)
* [数值表示法](http://javascript.ruanyifeng.com/grammar/number.html)